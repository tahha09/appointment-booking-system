<div class="space-y-6 text-[#032f30]">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <h2 class="text-2xl font-bold text-[#031716]">My Appointments</h2>
  </div>

  <!-- Filters -->
  <div class="rounded-2xl border border-[#d3e6eb] bg-white p-5 shadow-lg">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-semibold text-[#0a7075] mb-2">Status</label>
        <select
          [(ngModel)]="statusFilter"
          class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
        >
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold text-[#0a7075] mb-2">Date From</label>
        <input
          type="date"
          [(ngModel)]="dateFrom"
          class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
        />
      </div>

      <div>
        <label class="block text-sm font-semibold text-[#0a7075] mb-2">Date To</label>
        <input
          type="date"
          [(ngModel)]="dateTo"
          class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
        />
      </div>

      <div class="flex items-end gap-2">
        <button
          (click)="applyFilters()"
          class="flex-1 px-4 py-2 rounded-xl bg-[#0c969c] text-white font-semibold hover:bg-[#0a7075] transition"
        >
          Apply
        </button>
        <button
          (click)="resetFilters()"
          class="px-4 py-2 rounded-xl border border-[#6ba3be]/40 text-[#6ba3be] hover:bg-white/5 transition"
        >
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex items-center justify-center py-20">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-[#0c969c] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-[#6ba3be]">Loading appointments...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="rounded-2xl border border-red-500/40 bg-red-500/10 p-4">
    <p class="text-red-300">{{ error }}</p>
  </div>

  <!-- Appointments List -->
  <div *ngIf="!loading && !error" class="space-y-4">
    <div *ngIf="appointments.length === 0" class="rounded-2xl border border-[#d3e6eb] bg-white p-8 text-center">
      <p class="text-[#6ba3be] text-lg">No appointments found.</p>
    </div>

    <div *ngFor="let appointment of appointments" class="rounded-2xl border border-[#d7ebef] bg-white p-6 shadow-lg hover:border-[#0c969c]/50 transition">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Patient Info -->
        <div class="flex-1">
          <div class="flex items-start gap-4">
            <div class="w-16 h-16 rounded-full bg-[#0c969c]/15 border-2 border-[#0c969c]/40 overflow-hidden flex-shrink-0">
              <img
                [src]="getUserImage(appointment.patient?.user || null)"
                [alt]="appointment.patient?.user?.name"
                class="w-full h-full object-cover"
              />
            </div>
            <div class="flex-1">
              <h3 class="text-xl font-bold text-[#031716] mb-1">{{ appointment.patient?.user?.name || 'Unknown Patient' }}</h3>
              <p class="text-sm text-[#6ba3be] mb-2">{{ appointment.patient?.user?.email }}</p>
              <p class="text-sm text-[#6ba3be]">{{ appointment.patient?.user?.phone }}</p>
            </div>
          </div>
        </div>

        <!-- Appointment Details -->
        <div class="flex-1 space-y-2">
          <div class="flex items-center gap-2">
            <span class="text-sm text-[#6ba3be]">Date:</span>
            <span class="text-[#031716] font-semibold">{{ formatDate(appointment.appointment_date) }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-[#6ba3be]">Time:</span>
            <span class="text-[#031716] font-semibold">{{ formatTime(appointment.start_time) }} - {{ formatTime(appointment.end_time) }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-[#6ba3be]">Status:</span>
            <span [class]="'px-3 py-1 rounded-full text-xs font-semibold border ' + getStatusColor(appointment.status)">
              {{ appointment.status | titlecase }}
            </span>
          </div>
          <div *ngIf="appointment.payment?.amount || appointment.payment?.payment_method || appointment.amount || appointment.payment_method" class="flex flex-col gap-2 mt-2 pt-2 border-t border-[#6ba3be]/20">
            <div class="flex items-center gap-2">
              <span class="text-sm text-[#6ba3be]">Payment Amount:</span>
              <span class="text-[#031716] font-semibold">{{ formatCurrency(appointment.payment?.amount || appointment.amount || 0) }}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-[#6ba3be]">Payment Method:</span>
              <span class="text-[#031716] font-semibold">{{ (appointment.payment?.payment_method || appointment.payment_method || 'N/A') | titlecase }}</span>
            </div>
          </div>
          <div *ngIf="appointment.reason" class="mt-2">
            <span class="text-sm text-[#6ba3be]">Reason:</span>
            <p class="text-sm text-[#032f30] mt-1">{{ appointment.reason }}</p>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col gap-3">
          <button
            (click)="viewPatientDetails(appointment.patient)"
            class="px-4 py-2 rounded-xl border border-[#0c969c]/50 text-[#0c969c] bg-[#0c969c]/10 font-semibold hover:bg-[#0c969c]/20 transition text-sm"
          >
            View Patient
          </button>

          <div class="flex flex-col gap-2">
            <button
              *ngIf="appointment.status === 'pending'"
              (click)="updateStatus(appointment.id, 'confirmed')"
              [disabled]="updatingStatus === appointment.id"
              class="px-4 py-2 rounded-xl border border-emerald-400/50 text-emerald-500 bg-emerald-400/10 hover:bg-emerald-400/20 font-semibold transition text-sm tracking-wide shadow-sm shadow-black/20 disabled:opacity-50"
            >
              {{ updatingStatus === appointment.id ? 'Updating...' : 'Accept' }}
            </button>


            <button
              *ngIf="appointment.status === 'confirmed' || appointment.status === 'pending'"
              (click)="updateStatus(appointment.id, 'cancelled')"
              [disabled]="updatingStatus === appointment.id"
              class="px-4 py-2 rounded-xl border border-orange-400/50 text-orange-500 bg-orange-400/10 hover:bg-orange-400/20 font-semibold transition text-sm tracking-wide shadow-sm shadow-black/20 disabled:opacity-50"
            >
              {{ updatingStatus === appointment.id ? 'Updating...' : 'Cancel' }}
            </button>

            <button
              *ngIf="appointment.status === 'confirmed'"
              (click)="completeAppointment(appointment)"
              [disabled]="updatingStatus === appointment.id"
              class="px-4 py-2 rounded-xl border border-blue-400/50 text-blue-500 bg-blue-400/10 hover:bg-blue-400/20 font-semibold transition text-sm tracking-wide shadow-sm shadow-black/20 disabled:opacity-50"
            >
              Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="pagination && pagination.last_page > 1" class="flex items-center justify-center gap-2 mt-6">
      <button
        (click)="goToPage(pagination!.current_page - 1)"
        [disabled]="pagination!.current_page === 1"
        class="px-4 py-2 rounded-xl border border-[#6ba3be]/40 text-[#6ba3be] hover:bg-white/5 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Previous
      </button>

      <span class="text-[#6ba3be]">
        Page {{ pagination!.current_page }} of {{ pagination!.last_page }}
      </span>

      <button
        (click)="goToPage(pagination!.current_page + 1)"
        [disabled]="pagination!.current_page === pagination!.last_page"
        class="px-4 py-2 rounded-xl border border-[#6ba3be]/40 text-[#6ba3be] hover:bg-white/5 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Next
      </button>
    </div>
  </div>

  <!-- Patient Details Modal -->
  <div
    *ngIf="showPatientModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    (click)="closePatientModal()"
  >
    <div
      class="bg-white text-[#032f30] rounded-2xl border border-[#d7ebef] p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-[#031716]">Patient Details</h3>
        <button
          (click)="closePatientModal()"
          class="w-8 h-8 rounded-full bg-red-500/20 text-red-500 hover:bg-red-500/30 transition flex items-center justify-center"
        >
x
        </button>
      </div>

        <div *ngIf="patientDetailsLoading" class="rounded-2xl border border-[#0c969c]/30 bg-[#0c969c]/5 px-4 py-3 flex items-center gap-3 text-sm text-[#0a7075] mb-4">
        <span class="w-5 h-5 border-2 border-[#0c969c] border-t-transparent rounded-full animate-spin inline-block"></span>
        Loading patient details...
      </div>

      <div *ngIf="patientDetailsError" class="rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-500 mb-4">
        {{ patientDetailsError }}
      </div>

      <div *ngIf="selectedPatient && !patientDetailsLoading" class="space-y-4">
        <div class="flex items-center gap-4">
          <div class="w-24 h-24 rounded-full bg-[#0c969c]/10 border-2 border-[#0c969c]/40 overflow-hidden">
            <img
              [src]="getUserImage(selectedPatient?.user || null)"
              [alt]="selectedPatient?.user?.name"
              class="w-full h-full object-cover"
            />
          </div>
          <div>
            <h4 class="text-xl font-bold text-[#031716]">{{ selectedPatient?.user?.name }}</h4>
            <p class="text-[#6ba3be]">{{ selectedPatient?.user?.email }}</p>
            <p class="text-[#6ba3be]">{{ selectedPatient?.user?.phone }}</p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 border-t border-[#6ba3be]/30">
          <div>
            <span class="text-sm text-[#6ba3be]">Date of Birth:</span>
            <p>{{ formatDate(selectedPatient?.user?.date_of_birth) }}</p>
          </div>
          <div>
            <span class="text-sm text-[#6ba3be]">Address:</span>
            <p>{{ selectedPatient?.user?.address || 'N/A' }}</p>
          </div>
          <div>
            <span class="text-sm text-[#6ba3be]">Blood Type:</span>
            <p>{{ selectedPatient?.blood_type || 'N/A' }}</p>
          </div>
          <div *ngIf="selectedPatient?.allergies">
            <span class="text-sm text-[#6ba3be]">Allergies:</span>
            <p>{{ selectedPatient.allergies }}</p>
          </div>
        </div>

        <div *ngIf="selectedPatient?.medical_history" class="pt-4 border-t border-[#6ba3be]/30">
          <span class="text-sm text-[#6ba3be]">Medical History:</span>
          <p class="text-sm mt-1">{{ selectedPatient.medical_history }}</p>
        </div>

        <div *ngIf="selectedPatient?.chronic_conditions" class="pt-4 border-t border-[#6ba3be]/30">
          <span class="text-sm text-[#6ba3be]">Chronic Conditions:</span>
          <p class="text-sm mt-1">{{ selectedPatient.chronic_conditions }}</p>
        </div>

        <div *ngIf="selectedPatient?.medical_images && selectedPatient.medical_images.length > 0" class="pt-4 border-t border-[#6ba3be]/30">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm text-[#6ba3be] uppercase tracking-wide">Medical Images</span>
            <span class="text-xs text-[#6ba3be]">
              {{ selectedPatient.medical_images.length }} record{{ selectedPatient.medical_images.length === 1 ? '' : 's' }}
            </span>
          </div>

          <div class="space-y-3">
            <div *ngFor="let record of selectedPatient.medical_images" class="rounded-xl border border-[#d3e6eb] bg-[#f8feff] p-4">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
                <div>
                  <p class="text-sm font-semibold text-[#031716]">
                    {{ record.title || 'Untitled Record' }}
                  </p>
                  <p class="text-xs text-[#6ba3be] capitalize">{{ record.image_type || 'unknown' }}</p>
                </div>
                <div class="text-xs text-[#6ba3be]">
                  {{ formatDate(record.created_at) }}
                </div>
              </div>

              <p class="text-sm text-[#032f30] mb-2" *ngIf="record.description">{{ record.description }}</p>

              <div *ngIf="record.images?.length; else recordNoImages" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3">
                <div *ngFor="let photo of record.images" class="relative rounded-xl border border-[#d7ebef] overflow-hidden bg-white">
                  <img [src]="getMediaImageUrl(photo)" alt="Medical image" class="w-full h-32 object-cover cursor-pointer" (click)="openImageModal(photo)" />
                </div>
              </div>
              <ng-template #recordNoImages>
                <p class="text-xs text-[#6ba3be] mt-2">No files attached to this record.</p>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Prescription Modal -->
  <div
    *ngIf="showPrescriptionModal"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    (click)="closePrescriptionModal()"
  >
    <div
      class="bg-white text-[#032f30] rounded-2xl border border-[#d7ebef] p-6 max-w-3xl w-full max-h-[95vh] overflow-y-auto shadow-2xl"
      (click)="$event.stopPropagation()"
    >
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold text-[#031716]">Save Prescription</h3>
          <p class="text-sm text-[#6ba3be] mt-1">Completing this form will mark the appointment as completed.</p>
        </div>
        <button
          (click)="closePrescriptionModal()"
          class="w-8 h-8 rounded-full bg-red-500/10 text-red-500 hover:bg-red-500/20 transition flex items-center justify-center"
          aria-label="Close prescription form"
        >
          &times;
        </button>
      </div>

      <div class="space-y-6">
        <div class="rounded-2xl border border-[#d7ebef] bg-[#f5fbfc] p-4 flex flex-col gap-1">
          <p class="text-sm text-[#6ba3be]">Patient</p>
          <p class="text-lg font-semibold text-[#031716]">
            {{ selectedAppointmentForPrescription?.patient?.user?.name || 'Unknown Patient' }}
          </p>
          <p class="text-sm text-[#6ba3be]">
            {{ selectedAppointmentForPrescription?.patient?.user?.email }}
          </p>
          <div class="text-sm text-[#6ba3be] mt-2">
            <span class="font-semibold text-[#031716]">Appointment:</span>
            {{
              selectedAppointmentForPrescription
                ? formatDate(selectedAppointmentForPrescription.appointment_date)
                : 'N/A'
            }}
            •
            {{
              selectedAppointmentForPrescription
                ? formatTime(selectedAppointmentForPrescription.start_time)
                : 'N/A'
            }}
          </div>
        </div>

        <form (submit)="submitPrescription(); $event.preventDefault()" class="space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Medication Name<span class="text-red-500">*</span></label>
              <input
                type="text"
                name="medication_name"
                [(ngModel)]="prescriptionForm.medication_name"
                required
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
                placeholder="e.g., Amoxicillin"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Dosage<span class="text-red-500">*</span></label>
              <input
                type="text"
                name="dosage"
                [(ngModel)]="prescriptionForm.dosage"
                required
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
                placeholder="e.g., 500 mg"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Frequency<span class="text-red-500">*</span></label>
              <input
                type="text"
                name="frequency"
                [(ngModel)]="prescriptionForm.frequency"
                required
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
                placeholder="e.g., Twice daily"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Duration<span class="text-red-500">*</span></label>
              <input
                type="text"
                name="duration"
                [(ngModel)]="prescriptionForm.duration"
                required
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
                placeholder="e.g., 7 days"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Prescribed Date</label>
              <input
                type="date"
                name="prescribed_date"
                [(ngModel)]="prescriptionForm.prescribed_date"
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
              />
            </div>
            <div>
              <label class="block text-sm font-semibold text-[#0a7075] mb-2">Status</label>
              <select
                name="status"
                [(ngModel)]="prescriptionForm.status"
                class="w-full px-4 py-2 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
              >
                <option *ngFor="let status of prescriptionStatuses" [value]="status">{{ status | titlecase }}</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-[#0a7075] mb-2">Instructions</label>
            <textarea
              name="instructions"
              [(ngModel)]="prescriptionForm.instructions"
              rows="3"
              class="w-full px-4 py-3 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
              placeholder="Provide instructions for the patient..."
            ></textarea>
          </div>

          <div>
            <label class="block text-sm font-semibold text-[#0a7075] mb-2">Notes</label>
            <textarea
              name="notes"
              [(ngModel)]="prescriptionForm.notes"
              rows="3"
              class="w-full px-4 py-3 rounded-xl bg-white border border-[#6ba3be]/50 text-[#032f30] focus:outline-none focus:ring-2 focus:ring-[#0c969c]"
              placeholder="Any additional notes about the visit..."
            ></textarea>
          </div>

          <div *ngIf="prescriptionError" class="rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-red-500 text-sm">
            {{ prescriptionError }}
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <button
              type="button"
              (click)="closePrescriptionModal()"
              class="px-4 py-2 rounded-xl border border-[#6ba3be]/40 text-[#6ba3be] hover:bg-white/5 transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="savingPrescription"
              class="px-6 py-2 rounded-xl bg-[#0c969c] text-white font-semibold hover:bg-[#0a7075] transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {{ savingPrescription ? 'Saving...' : 'Save & Complete' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div
    *ngIf="showImageModal && selectedImageForModal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    (click)="closeImageModal()"
  >
    <div class="relative max-w-4xl max-h-[90vh] w-full h-full flex items-center justify-center" (click)="$event.stopPropagation()">
      <button
        (click)="closeImageModal()"
        class="absolute top-4 right-4 w-10 h-10 rounded-full bg-red-500/20 text-red-500 hover:bg-red-500/30 transition flex items-center justify-center z-10"
      >
        ×
      </button>
      <img [src]="selectedImageForModal" alt="Medical image" class="max-w-full max-h-full object-contain rounded-lg" />
    </div>
  </div>
</div>
